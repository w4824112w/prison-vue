//关闭了调试信息
console={log:function(){}},function(){function c(a){this._document=a;var b=this;a.attachEvent("onselectionchange",function(){b._selectionChangeHandler()}),a.attachEvent("onbeforedeactivate",function(){b._beforedeactivateHandler()}),a.attachEvent("onactivate",function(){b._activateHandler()})}function a(a,b){this._document=a,this._range=b||this._document.selection.createRange(),this._refreshAll(this._range)}a.START_TO_START=0,a.START_TO_END=1,a.END_TO_END=2,a.END_TO_START=3,a.prototype={startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:!1,_document:null,_comparArr:["StartToStart","StartToEnd","EndToEnd","EndToStart"],_refreshProperties:function(){this.collapsed=this._range.boundingWidth===0;try{this.commonAncestorContainer=this._range.parentElement()}catch(a){this.commonAncestorContainer=this._range.item(0)}},_refreshAll:function(a){this._range=a||this._document.selection.createRange(),this._refreshProperties(),this._refreshContainer()},_refreshContainer:function(){console.log("_refreshContainer");var a=function(a,b){var c=a.duplicate(),d=a.duplicate(),e={},f=b?"StartToEnd":"EndToStart",g=b?"moveStart":"moveEnd";c.collapse(b);if(c.parentElement().document!==this._document)return{container:null,offset:0};var h=c.parentElement(),i=h.childNodes,j=this.__getRefA("container"),k=this.__getRefA("container"),l=d.duplicate(),m=0,n=0,o,p;for(;i[n];n++){o=i[n],o.nodeType===3?(h.insertBefore(j,o),this.__insertAfter(k,o,h),d.moveToElementText(j),l.moveToElementText(j),d.setEndPoint("StartToStart",l),l.moveToElementText(k),d.setEndPoint("StartToEnd",l),j=h.removeChild(j),k=h.removeChild(k)):d.moveToElementText(o);if(d.inRange(c)){e.container=o,p=(o.data||o.value||o.innerHTML).length,b||d.collapse(!0);while(d.compareEndPoints(f,c)&&m<p)m++,d[g]("character",1);e.offset=m;break}}return e},b=+(new Date);this._document.body.firstChild||(this._document.body.innerHTML="&nbsp;"),this._document.parentWindow.focus();if(this._range.item){var c=this._range.item(0),d=c.parentNode,e=d.childNodes,f=0;this.startContainer=d,this.endContainer=d;for(;e[f];f++)if(e[f]===c){this.startOffset=f,this.endOffset=f+1;return}}var g=a.call(this,this._range,!0);this.startContainer=g.container||this._document.body.firstChild,this.startOffset=g.offset,this.collapsed||(g=a.call(this,this._range,!1)),this.endContainer=g.container||this._document.body.firstChild,this.endOffset=g.offset,this._range.select();var h=+(new Date);console.log(".......exec _refreshContainer time:"+(h-b))},__getRefA:function(a){var b=document.createElement("a");b.innerHTML="&nbsp;";return b},__insertAfter:function(a,b,c){c=c||b.parentNode,c.lastChild===b?c.appendChild(a):c.insertBefore(a,b.nextSibling)},__moveToElementText:function(a,b,c){var d=c.childNodes,e=this.__getRefA(),f=this.__getRefA(),g=this._range.duplicate(),h=this._range.duplicate(),b=b||this._range,c=c||a.parentNode;c.insertBefore(e,a),this.__insertAfter(f,a,c),g.moveToElementText(e),h.moveToElementText(f),b.setEndPoint("StartToStart",g),b.setEndPoint("EndToEnd",h),c.removeChild(e),c.removeChild(f)},__setterMethod:function(a,b,c){var d=this._range.duplicate(),e,f,g;c?(e="StartToStart",f="startContainer",g="startOffset"):(e="EndToEnd",f="endContainer",g="endOffset");if(a.nodeType===3){console.log("DOM:data");var h=a.parentNode;this.__moveToElementText(a,d,h);if(b===0){var i=this.__getRefA("__setterMethod");console.log(h.innerHTML),h.insertBefore(i,a),console.log(h.innerHTML),d.moveToElementText(i),d.collapse(!1),this._range.setEndPoint(e,d),h.removeChild(i)}else c||d.collapse(!0),d.moveStart("character",b),this._range.setEndPoint(e,d)}else{console.log("DOM:element"),d.moveToElementText(a);var j=a.childNodes[b],i=this.__getRefA("__setterMethod");j?(console.log("not last one"),a.insertBefore(i,j)):(console.log("lastOne"),a.appendChild(i)),d.moveToElementText(i),d.collapse(!1),this._range.setEndPoint(e,d),a.removeChild(i)}this[f]=a,this[g]=b,this._refreshProperties()},__setterWhereMethod:function(a,b,c){var d=this.__getRefA("__setterWhereMethod"),e=a.parentNode,f=this._range.duplicate(),g=0,h,i,j;b?(h="StartToStart",i="startContainer",j="startOffset"):(h="EndToEnd",i="endContainer",j="endOffset"),c?e.insertBefore(d,a):this.__insertAfter(d,a);for(;e.childNodes[g];g++)if(d===e.childNodes[g]){this[i]=e,this[j]=g,f.moveToElementText(d),f.collapse(!1),this._range.setEndPoint(h,f),e.removeChild(d);break}this._refreshProperties()},setStart:function(a,b){console.log("setStart"),this.__setterMethod(a,b,!0)},setEnd:function(a,b){console.log("setEnd"),this.__setterMethod(a,b,!1)},setStartBefore:function(a){console.log("setStartBefore"),this.__setterWhereMethod(a,!0,!0)},setStartAfter:function(a){console.log("setStartAfter"),this.__setterWhereMethod(a,!0,!1)},setEndBefore:function(a){console.log("setEndBefore"),this.__setterWhereMethod(a,!1,!0)},setEndAfter:function(a){console.log("setEndAfter"),this.__setterWhereMethod(a,!1,!1)},selectNode:function(a){console.log("selectNode");if(a.nodeType!==3){this._range.moveToElementText(a);var b=this.__getRefA("selectNode");a.parentNode.insertBefore(b,a);var c=this._range.duplicate();c.moveToElementText(b),c.collapse(!0),this._range.setEndPoint("StartToStart",c),a.parentNode.removeChild(b)}else this._range.moveToElementText(a.parentNode);this.__setterWhereMethod(a,!0,!0),this.__setterWhereMethod(a,!1,!1),this._range.select()},selectNodeContents:function(a){console.log("selectNodeContents");var b=this.__getRefA("selectNodeContents"),c=this.__getRefA("selectNodeContents"),d=this._range.duplicate(),e=this._range.duplicate(),f=0;this.startContainer=a,this.endContainer=a,this.startOffset=0;if(a.nodeType!==3)this.endOffset=a.childNodes.length,this._range.moveToElementText(a),a.insertBefore(b,a.firstChild),a.appendChild(c);else{var g=a.parentNode,h=g.childNodes;for(;h[f];f++)if(h[f]===a){this.endOffset=a.data.length,g.insertBefore(b,a),this.__insertAfter(c,a),this._range.moveToElementText(b);break}}d.moveToElementText(b),d.collapse(!1),e.moveToElementText(c),this._range.setEndPoint("StartToEnd",e),this._range.setEndPoint("StartToStart",d),b.parentNode.removeChild(b),c.parentNode.removeChild(c),this._refreshProperties()},collapse:function(a){console.log("collapse"),this._range.collapse(a),this._refreshAll(this._range)},cloneContents:function(){return""},extractContents:function(){console.log("extractContents");var a=this._document.createDocumentFragment(),b=this._document.createElement("div"),c=0;b.innerHTML=this._range.htmlText;while(b.childNodes[c])a.appendChild(b.childNodes[c]);this._range.pasteHTML(""),this._refreshProperties();return a},deleteContents:function(){console.log("deleteContents"),this._range.pasteHTML(""),this._range=this._document.selection.createRange(),this._refreshAll();return},insertNode:function(a,b){console.log("insertNode");var c=this.__getRefA("insertNode");this._document.body.insertBefore(c,this._document.body.firstChild);var d=this._range.duplicate();d.collapse(!0),d.pasteHTML('<a id="insertNode"></a>');var e=this._document.getElementById("insertNode");this.__insertAfter(a,e),e.parentNode.removeChild(e),this._document.body.removeChild(c),this._refreshAll()},surroundContents:function(a){console.log("surroundContents");var b=this._range.duplicate();b.collapse(!0),b.pasteHTML('<a id="insertNode"></a>');var c=this._document.getElementById("insertNode");this.__insertAfter(a,c);var d=this.extractContents();a.appendChild(d),c.parentNode.removeChild(c),this._refreshProperties()},compareBoundaryPoints:function(a,b){console.log("compareBoundaryPoints");try{return this._document.selection.createRange().compareEndPoints(this._comparArr[a],b._range)}catch(c){return-1}},cloneRange:function(){console.log("cloneRange");var b;try{b=new a(this._document,this._range.duplicate())}catch(c){b=new a(this._document)}b.startContainer=this.startContainer,b.endContainer=this.endContainer,b.startOffset=this.startOffset,b.endOffset=this.endOffset,b.collapsed=this.collapsed,b.commonAncestorContainer=this.commonAncestorContainer;return b},detach:function(){},toString:function(){console.log("toString");return this._range.text},createContextualFragment:function(a){console.log("createContextualFragment");var b=(DOMUtils.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(!1);b.innerHTML=a;for(var c=this._document.createDocumentFragment();b.firstChild;)c.appendChild(b.firstChild);return c}};var b=null;c.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_beforedeactivateHandler:function(){if(!b)return!1;try{this._ieSelectionBookmark=b._range.getBookmark()}catch(a){this._ieSelectionElement=b._range.item(0)}},_activateHandler:function(){try{if(this._ieSelectionBookmark){b._range.moveToBookmark(this._ieSelectionBookmark),b._range.select(),this._ieSelectionBookmark=null;return!1}}catch(a){if(this._ieSelectionElement){try{this._ieSelectionElement.parent()}catch(a){this._ieSelectionElement=null,b._refreshAll();return!1}var c=b.__getRefA(),d=b.__getRefA(),e=this._ieSelectionElement.parentNode,f=this._document.selection.createRange(),g=f.duplicate(),h=f.duplicate();e.insertBefore(c,this._ieSelectionElement),g.moveToElementText(c),b.__insertAfter(d,this._ieSelectionElement,e),h.moveToElementText(d),f.moveToElementText(c),f.setEndPoint("StartToStart",g),f.setEndPoint("EndToEnd",h),b._range=f,b._range.select(),e.removeChild(c),e.removeChild(d),this._ieSelectionElement=null;return!1}}},_selectionExists:function(a){try{return a.compareEndPoints("StartToEnd",a)!=0||a.parentElement().isContentEditable}catch(b){return!0}},addRange:function(a){a._range.select();return},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(c){if(!b){b=new a(this._document);return b}b._refreshAll();return b},toString:function(){return this._document.selection.createRange().text}};var d=/msie (\d+)\./.exec(navigator.userAgent.toLowerCase())||[],e=d[1];if(!(!e||e<6))if(e<9){console.log("-----------------------------------------使用过度range"),document.createRange=function(){if(!b){b=new a(document);return b}b._refreshAll();return b};var f=new c(document);window.getSelection=function(){return f},window.Range=a,window.parent&&(window.parent.Range=a)}else{console.log("-----------------------------------------使用原生range");var f=window.getSelection(),g;document.attachEvent("onbeforedeactivate",function(){try{g=f.getRangeAt(0)}catch(a){}}),document.attachEvent("onactivate",function(){g&&(f.removeAllRanges(),f.addRange(g)),g=null})}}()